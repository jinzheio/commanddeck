<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CommandDeck</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
        background: #0b0b10;
        color: #e7e8f2;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: 320px;
        padding: 24px;
        border-right: 1px solid #202030;
        background: #0f1018;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .content {
        flex: 1;
        padding: 24px 32px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      h1 {
        margin: 0 0 4px;
        font-size: 24px;
      }
      h2 {
        margin: 0 0 8px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: #8c92b8;
      }
      label {
        display: block;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #8c92b8;
        margin-bottom: 6px;
      }
      input,
      select,
      button {
        font-size: 14px;
      }
      input,
      select {
        width: 100%;
        padding: 10px 12px;
        background: #171a27;
        border: 1px solid #2b314a;
        color: #e7e8f2;
        border-radius: 8px;
        margin-bottom: 8px;
      }
      button {
        width: 100%;
        padding: 10px 12px;
        border: none;
        border-radius: 8px;
        background: #5b6bff;
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
      }
      button.secondary {
        background: #2b314a;
      }
      button:disabled {
        background: #3b3f5c;
        cursor: not-allowed;
      }
      .status {
        font-size: 13px;
        color: #8c92b8;
      }
      .list {
        display: grid;
        gap: 8px;
      }
      .list button {
        text-align: left;
        background: #171a27;
        border: 1px solid #2b314a;
        font-weight: 500;
      }
      .list button.active {
        background: #2b314a;
      }
      .panel {
        padding: 16px;
        background: #121522;
        border: 1px solid #232842;
        border-radius: 12px;
      }
      .log {
        margin-top: 12px;
        padding: 12px;
        background: #0e111c;
        border-radius: 10px;
        border: 1px solid #232842;
        max-height: 240px;
        overflow: auto;
        font-size: 12px;
        color: #c7cae6;
        white-space: pre-wrap;
      }
      .events {
        display: grid;
        gap: 12px;
      }
      .event {
        padding: 16px;
        background: #121522;
        border: 1px solid #232842;
        border-radius: 12px;
      }
      .event header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 13px;
        color: #8c92b8;
      }
      .event .meta {
        font-size: 14px;
        margin-bottom: 6px;
      }
      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #232842;
        color: #b5b9e2;
        font-size: 12px;
      }
      pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 12px;
        color: #c7cae6;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div>
        <h1>CommandDeck</h1>
        <div class="status" id="status">Disconnected</div>
      </div>

      <div>
        <h2>Projects</h2>
        <div class="list" id="project-list"></div>
        <label for="project-name">Add Project</label>
        <input id="project-name" placeholder="e.g. mpwriter" />
        <button id="project-add" class="secondary">Add Project</button>
      </div>

      <div>
        <h2>Hub</h2>
        <label for="hub">Hub URL</label>
        <input id="hub" placeholder="ws://127.0.0.1:8787/stream" />
        <button id="connect">Connect</button>
      </div>

      <div>
        <h2>Agents</h2>
        <button id="agent-start">Start Agent</button>
        <div class="list" id="agent-list"></div>
      </div>
    </aside>

    <main class="content">
      <section class="panel">
        <h2>Message Agent</h2>
        <label for="agent-select">Running Agent</label>
        <select id="agent-select"></select>
        <label for="agent-message">Message</label>
        <input id="agent-message" placeholder="Type a message and press Send" />
        <button id="agent-send">Send</button>
        <div class="status" id="agent-status"></div>
        <div class="log" id="agent-log">No logs yet.</div>
      </section>

      <section class="events" id="events"></section>
    </main>

    <script>
      const api = window.commanddeck;
      const projectListEl = document.getElementById("project-list");
      const projectNameInput = document.getElementById("project-name");
      const projectAddButton = document.getElementById("project-add");
      const hubInput = document.getElementById("hub");
      const connectButton = document.getElementById("connect");
      const statusEl = document.getElementById("status");
      const agentStartButton = document.getElementById("agent-start");
      const agentListEl = document.getElementById("agent-list");
      const agentSelect = document.getElementById("agent-select");
      const agentMessage = document.getElementById("agent-message");
      const agentSendButton = document.getElementById("agent-send");
      const agentStatus = document.getElementById("agent-status");
      const agentLog = document.getElementById("agent-log");
      const eventsEl = document.getElementById("events");

      let socket;
      let lastEventId = 0;
      let projects = [];
      let agents = [];
      let selectedProject = localStorage.getItem("commanddeck.project") || "";
      let isConnected = false;

      hubInput.value =
        localStorage.getItem("commanddeck.hub") ||
        "ws://127.0.0.1:8787/stream";

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function renderProjects() {
        projectListEl.innerHTML = "";
        projects.forEach((project) => {
          const button = document.createElement("button");
          button.textContent = project.name;
          if (project.name === selectedProject) {
            button.classList.add("active");
          }
          button.addEventListener("click", () => {
            selectedProject = project.name;
            localStorage.setItem("commanddeck.project", selectedProject);
            renderProjects();
            renderAgents();
            connect();
          });
          projectListEl.appendChild(button);
        });

        if (!selectedProject && projects.length > 0) {
          selectedProject = projects[0].name;
          localStorage.setItem("commanddeck.project", selectedProject);
        }
      }

      function renderAgents() {
        const filtered = agents.filter(
          (agent) => agent.project === selectedProject
        );
        agentListEl.innerHTML = "";
        agentSelect.innerHTML = "";

        filtered.forEach((agent) => {
          const button = document.createElement("button");
          button.textContent = `${agent.name} (pid ${agent.pid})`;
          agentListEl.appendChild(button);

          const option = document.createElement("option");
          option.value = agent.id;
          option.textContent = agent.name;
          agentSelect.appendChild(option);
        });

        agentSendButton.disabled = filtered.length === 0;
        if (filtered.length === 0) {
          agentLog.textContent = "No logs yet.";
        }
      }

      function appendEvent(event) {
        lastEventId = Math.max(lastEventId, event.event_id || 0);

        const card = document.createElement("div");
        card.className = "event";

        const header = document.createElement("header");
        header.innerHTML = `<span>#${event.event_id}</span><span>${event.server_ts}</span>`;
        card.appendChild(header);

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<strong>${event.agent_id}</strong> · ${event.type} · <span class="tag">${event.state}</span>`;
        card.appendChild(meta);

        const payload = document.createElement("pre");
        payload.textContent = JSON.stringify(event.payload || {}, null, 2);
        card.appendChild(payload);

        eventsEl.prepend(card);
      }

      function handleMessage(data) {
        if (data.type === "init") {
          eventsEl.innerHTML = "";
          data.events.forEach(appendEvent);
          return;
        }
        if (data.type === "event") {
          appendEvent(data.event);
        }
      }

      function connect() {
        if (!selectedProject) {
          setStatus("Select a project first");
          return;
        }
        const hubUrl = hubInput.value.trim();
        localStorage.setItem("commanddeck.hub", hubUrl);

        if (socket) {
          socket.close();
        }

        socket = new WebSocket(hubUrl);
        connectButton.disabled = false;
        setStatus("Connecting...");
        connectButton.textContent = "Connecting...";

        socket.addEventListener("open", () => {
          setStatus(`Connected to ${hubUrl}`);
          isConnected = true;
          connectButton.textContent = "Disconnect";
          socket.send(
            JSON.stringify({
              type: "subscribe",
              project_id: selectedProject,
              since_event_id: lastEventId,
            })
          );
        });

        socket.addEventListener("message", (event) => {
          try {
            handleMessage(JSON.parse(event.data));
          } catch (error) {
            console.error("Invalid message", error);
          }
        });

        socket.addEventListener("close", () => {
          setStatus("Disconnected");
          isConnected = false;
          connectButton.textContent = "Connect";
        });

        socket.addEventListener("error", () => {
          setStatus("Connection error");
          isConnected = false;
          connectButton.textContent = "Connect";
        });
      }

      async function refreshProjects() {
        projects = await api.getProjects();
        renderProjects();
        renderAgents();
      }

      async function refreshAgents() {
        agents = await api.getAgents();
        renderAgents();
      }

      projectAddButton.addEventListener("click", async () => {
        const name = projectNameInput.value.trim();
        if (!name) return;
        const result = await api.addProject(name);
        if (!result.ok && result.reason === "missing") {
          const confirmed = window.confirm(
            `Project folder not found. Create ${result.path}?`
          );
          if (confirmed) {
            await api.createProject(name);
          }
        }
        projectNameInput.value = "";
        await refreshProjects();
      });

      connectButton.addEventListener("click", () => {
        if (isConnected && socket) {
          socket.close();
          return;
        }
        connect();
      });

      agentStartButton.addEventListener("click", async () => {
        if (!selectedProject) {
          setStatus("Select a project first");
          return;
        }
        const hubUrl = hubInput.value.trim();
        agentStartButton.disabled = true;
        const result = await api.startAgent({
          projectName: selectedProject,
          hubUrl,
        });
        if (!result.ok) {
          setStatus(
            `Failed to start agent: ${result.reason || "unknown"}${
              result.error ? ` (${result.error})` : ""
            }`
          );
        } else {
          setStatus(`Started agent ${result.agent.name}`);
        }
        agentStartButton.disabled = false;
        await refreshAgents();
      });

      agentSendButton.addEventListener("click", async () => {
        const agentId = agentSelect.value;
        const text = agentMessage.value.trim();
        if (!agentId || !text) return;
        const result = await api.sendMessage({ agentId, text });
        if (result.ok) {
          agentStatus.textContent = "Message sent";
        } else {
          agentStatus.textContent = `Send failed: ${result.reason || "unknown"}${
            result.error ? ` (${result.error})` : ""
          }`;
        }
        agentMessage.value = "";
      });

      agentSelect.addEventListener("change", async () => {
        const agentId = agentSelect.value;
        const logs = await api.getAgentLogs(agentId);
        agentLog.textContent = logs.length ? logs.join("") : "No logs yet.";
      });

      api.onAgentsChanged((nextAgents) => {
        agents = nextAgents;
        renderAgents();
      });

      api.onAgentLog(({ id, line }) => {
        if (agentSelect.value === id) {
          agentLog.textContent += line;
          agentLog.scrollTop = agentLog.scrollHeight;
        }
      });

      api.onAgentExit(({ id, reason, error }) => {
        if (agentSelect.value === id) {
          agentLog.textContent += `\n[agent exited: ${reason}${
            error ? ` (${error})` : ""
          }]\n`;
        }
      });

      api.onProjectsChanged((nextProjects) => {
        projects = nextProjects;
        renderProjects();
      });

      refreshProjects();
      refreshAgents();
    </script>
  </body>
</html>
